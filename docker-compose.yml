version: '3.7'
services:
    cdc-using-debezium-postgres:
        image: postgres:11
        container_name: cdc-using-debezium-postgres
        hostname: cdc-using-debezium-postgres
        restart: always
        ports:
            - '5443:5432'
        environment:
            POSTGRES_PASSWORD: 123
            POSTGRES_USER: postgres
            POSTGRES_DB: cdc-using-debezium
        command: ['postgres', '-c', 'wal_level=logical']
        volumes:
            - 'cdc-using-debezium-postgres-data:/var/lib/postgresql/data'
        networks:
            - cdc-using-debezium-network

#    cdc-using-debezium-zookeeper:
#        # image: quay.io/debezium/zookeeper:2.3
#        image: zookeeper:3.8
#        container_name: cdc-using-debezium-zookeeper
#        hostname: cdc-using-debezium-zookeeper
#        restart: always
#        ports:
#            - '2181:2181'
#            - '2888:2888'
#            - '3888:3888'
#        environment:
#            ALLOW_ANONYMOUS_LOGIN: 'true'
#        networks:
#            - cdc-using-debezium-network

    cdc-using-debezium-kafka:
#        verify that Kafka started: docker-compose logs -f cdc-using-debezium-kafka | grep -i started
#        image: quay.io/debezium/kafka:2.3
        image: bitnami/kafka:3.4
        container_name: cdc-using-debezium-kafka
        hostname: cdc-using-debezium-kafka
        restart: always
        ports:
            - '9092:9092'
        environment:
#            KAFKA_CFG_ZOOKEEPER_CONNECT: cdc-using-debezium-zookeeper:2181
#            KAFKA_CFG_ZOOKEEPER_METADATA_MIGRATION_ENABLE: 'true'
            KAFKA_CFG_NODE_ID: 1
            KAFKA_KRAFT_CLUSTER_ID: q0k00yjQRaqWmAAAZv955w # base64 UUID
            KAFKA_CFG_PROCESS_ROLES: controller,broker
            KAFKA_CFG_LISTENERS: INSIDE://:9092,OUTSIDE://:9093
            KAFKA_CFG_ADVERTISED_LISTENERS: INSIDE://:9092
            KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
            KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@cdc-using-debezium-kafka:9093
            KAFKA_CFG_INTER_BROKER_LISTENER_NAME: INSIDE
            KAFKA_CFG_CONTROLLER_LISTENER_NAMES: OUTSIDE
#        links:
#            - cdc-using-debezium-zookeeper
        networks:
            - cdc-using-debezium-network

    cdc-using-debezium-connect:
        image: debezium/connect:2.3
        container_name: cdc-using-debezium-connect
        hostname: cdc-using-debezium-connect
        restart: always
        ports:
            - '8083:8083'
        environment:
            BOOTSTRAP_SERVERS: cdc-using-debezium-kafka:9092
            GROUP_ID: 1
            CONFIG_STORAGE_TOPIC: my_connect_configs
            OFFSET_STORAGE_TOPIC: my_connect_offsets
            STATUS_STORAGE_TOPIC: my_connect_statuses
            ENABLE_DEBEZIUM_SCRIPTING: 'true'
        links:
            - cdc-using-debezium-kafka
            - cdc-using-debezium-postgres
        networks:
            - cdc-using-debezium-network

    debezium-ui:
        image: debezium/debezium-ui:2.4
        container_name: debezium-ui
        hostname: debezium-ui
        restart: always
        ports:
            - '8099:8080'
        environment:
            KAFKA_CONNECT_URIS: http://192.168.1.110:8083
        links:
            - cdc-using-debezium-connect
        networks:
            - cdc-using-debezium-network

networks:
    cdc-using-debezium-network:
        name: cdc-using-debezium-network
        driver: bridge
        external: false

volumes:
    cdc-using-debezium-postgres-data:
        name: cdc-using-debezium-postgres-data
        driver: local
